# ---------- Base image ----------
FROM nvidia/cuda:11.8.0-runtime-ubuntu22.04

# ---------- System & Python ----------
ARG DEBIAN_FRONTEND=noninteractive
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        python3.10 python3-pip git && \
    rm -rf /var/lib/apt/lists/*

ENV PYTHONUNBUFFERED=1
WORKDIR /workspace

# ---------- Python deps ----------
# ① 一次性装好 Torch cu118 轮子
# ② 再装 vLLM（会自动识别 cu118）
RUN pip install --no-cache-dir \
        torch==2.1.0+cu118 \
        torchvision==0.16.0+cu118 \
        --extra-index-url https://download.pytorch.org/whl/cu118 && \
    pip install --no-cache-dir vllm[cu118]

# ---------- (可选) HF 缓存 ----------
ENV HF_HOME=/workspace/.cache/huggingface

# ---------- 端口 ----------
EXPOSE 8000

# ---------- Entrypoint ----------
# ENTRYPOINT 固定，CMD 可被 docker run 后续参数覆盖
ENTRYPOINT ["python", "-m", "vllm.entrypoints.openai.api_server"]
CMD ["--model","deepseek-10b-awq","--tokenizer","deepseek-10b-awq","--port","8000","--concurrency","16","--max-batch-tokens","8192","--log-dir","vllm_logs"]
